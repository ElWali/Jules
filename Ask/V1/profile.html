<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Profile</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { font-family: sans-serif; }
        #map { height: 300px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1 id="site-name"></h1>
    <div id="map"></div>
    <h2>Summary</h2>
    <p id="summary"></p>
    <h2>Radiocarbon Dates</h2>
    <table id="dates-table">
        <thead>
            <tr>
                <th>Lab Code</th>
                <th>BP</th>
                <th>Std</th>
                <th>Material</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <h2>Date Distribution</h2>
    <canvas id="date-chart" width="400" height="200"></canvas>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get site name from URL
            const urlParams = new URLSearchParams(window.location.search);
            const siteName = urlParams.get('site');

            if (siteName) {
                document.getElementById('site-name').textContent = decodeURIComponent(siteName);
                fetch('output.json')
                    .then(response => response.json())
                    .then(data => {
                        const siteData = data.filter(item => item.site === siteName);
                        if (siteData.length > 0) {
                            // For now, just use the first entry for lat/lon
                            const { latitude, longitude } = siteData[0];
                            const map = L.map('map').setView([latitude, longitude], 10);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                            }).addTo(map);
                            L.marker([latitude, longitude]).addTo(map);

                            // Populate the table
                            const tableBody = document.querySelector('#dates-table tbody');
                            siteData.forEach(item => {
                                const row = tableBody.insertRow();
                                row.insertCell(0).textContent = item.lab_code || 'N/A';
                                row.insertCell(1).textContent = item.bp;
                                row.insertCell(2).textContent = item.std;
                                row.insertCell(3).textContent = item.material;
                            });

                            // Summary (for now, just a count)
                            document.getElementById('summary').textContent = `Found ${siteData.length} records for this site.`;

                            // Create the chart
                            const ctx = document.getElementById('date-chart').getContext('2d');
                            const dates = siteData.map(item => item.bp);
                            const bins = {};
                            dates.forEach(date => {
                                const bin = Math.floor(date / 500) * 500;
                                bins[bin] = (bins[bin] || 0) + 1;
                            });

                            new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: Object.keys(bins).map(bin => `${bin}-${parseInt(bin) + 500} BP`),
                                    datasets: [{
                                        label: '# of Dates',
                                        data: Object.values(bins),
                                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                        borderColor: 'rgba(75, 192, 192, 1)',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    scales: {
                                        y: {
                                            beginAtZero: true
                                        }
                                    }
                                }
                            });
                        }
                    });
            }
        });
    </script>
</body>
</html>
