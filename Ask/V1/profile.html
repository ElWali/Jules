<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Profile</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
    <header>
        <a href="index.html">Home</a>
        <a href="sites.html">Browse</a>
    </header>

    <main class="container">
        <h1 id="site-name"></h1>
        <p>Archaeological site in <span id="site-country"></span></p>

        <div class="info-card">
            <h2>Location</h2>
            <table>
                <tr>
                    <th>Coordinates (degrees)</th>
                    <td id="coords-deg"></td>
                </tr>
                <tr>
                    <th>Coordinates (DMS)</th>
                    <td id="coords-dms"></td>
                </tr>
                <tr>
                    <th>Country</th>
                    <td id="country"></td>
                </tr>
            </table>
        </div>

        <div id="map" style="height: 400px; margin-bottom: 20px;"></div>

        <div class="info-card">
            <h2>Radiocarbon Dates</h2>
            <table id="c14-table" class="table">
                <thead>
                    <tr>
                        <th>Lab ID</th>
                        <th>Context</th>
                        <th>Material</th>
                        <th>Uncalibrated age</th>
                        <th>Calibrated age</th>
                        <th>References</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div class="info-card">
            <h2>Typological Dates</h2>
            <table id="typo-table" class="table">
                <thead>
                    <tr>
                        <th>Classification</th>
                        <th>References</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const siteName = decodeURIComponent(urlParams.get('id'));

            // Function to convert decimal degrees to DMS
            function toDMS(deg, isLat) {
                let d = Math.floor(Math.abs(deg));
                let minfloat = (Math.abs(deg) - d) * 60;
                let m = Math.floor(minfloat);
                let secfloat = (minfloat - m) * 60;
                let s = Math.round(secfloat);
                if (s === 60) { m++; s = 0; }
                if (m === 60) { d++; m = 0; }
                let dir = isLat ? (deg >= 0 ? 'N' : 'S') : (deg >= 0 ? 'E' : 'W');
                return `${d}° ${m}' ${s}" ${dir}`;
            }

            fetch('output.json')
                .then(response => response.json())
                .then(data => {
                    const siteRecords = data.filter(r => r.site === siteName);

                    if (siteRecords.length > 0) {
                        const firstRecord = siteRecords[0];
                        const site = {
                            name: firstRecord.site,
                            country: firstRecord.country,
                            lat: parseFloat(firstRecord.lat),
                            lng: parseFloat(firstRecord.lng),
                            c14_dates: [],
                            periods: new Set()
                        };

                        siteRecords.forEach(record => {
                            if (record.bp && record.std) {
                                site.c14_dates.push({
                                    lab_id: record.labnr || 'N/A',
                                    context: `${record.feature || ''} ${record.feature_type || ''}`.trim() || 'N/A',
                                    material: record.material || 'N/A',
                                    bp: record.bp,
                                    std: record.std,
                                    cal_bp_start: record.cal_bp_start || 'N/A',
                                    cal_bp_end: record.cal_bp_end || 'N/A',
                                    reference: record.reference || 'N/A'
                                });
                            }
                            if (record.periods) {
                                try {
                                    const parsedPeriods = JSON.parse(record.periods);
                                    if (Array.isArray(parsedPeriods)) {
                                        parsedPeriods.forEach(p => {
                                            if (p.periode) site.periods.add(JSON.stringify({
                                                name: p.periode,
                                                reference: record.reference || 'N/A'
                                            }));
                                        });
                                    }
                                } catch (e) {
                                    // no-op
                                }
                            }
                        });
                        site.periods = Array.from(site.periods).map(p => JSON.parse(p));

                        document.title = site.name + " | Site Profile";
                        document.getElementById('site-name').textContent = site.name;
                        document.getElementById('site-country').textContent = site.country;
                        document.getElementById('coords-deg').textContent = `${site.lat.toFixed(3)}° N, ${site.lng.toFixed(3)}° E`;
                        document.getElementById('coords-dms').textContent = `${toDMS(site.lat, true)}, ${toDMS(site.lng, false)}`;
                        document.getElementById('country').textContent = site.country;

                        const map = L.map('map').setView([site.lat, site.lng], 10);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                        L.marker([site.lat, site.lng]).addTo(map).bindPopup(site.name).openPopup();

                        const c14Table = document.getElementById('c14-table').querySelector('tbody');
                        if (site.c14_dates.length > 0) {
                            let c14Html = '';
                            site.c14_dates.forEach(date => {
                                c14Html += `<tr><td>${date.lab_id}</td><td>${date.context}</td><td>${date.material}</td><td>${date.bp}±${date.std}</td><td>${date.cal_bp_start}–${date.cal_bp_end} cal BP</td><td>${date.reference}</td></tr>`;
                            });
                            c14Table.innerHTML = c14Html;
                        } else {
                            c14Table.innerHTML = '<tr><td colspan="6">No radiocarbon dates available for this site.</td></tr>';
                        }

                        const typoTable = document.getElementById('typo-table').querySelector('tbody');
                        if (site.periods.length > 0) {
                            let typoHtml = '';
                            site.periods.forEach(period => {
                                typoHtml += `<tr><td>${period.name}</td><td>${period.reference}</td></tr>`;
                            });
                            typoTable.innerHTML = typoHtml;
                        } else {
                            typoTable.innerHTML = '<tr><td colspan="2">No typological dates available for this site.</td></tr>';
                        }
                    } else {
                        document.getElementById('site-name').textContent = "Site not found";
                    }
                });
        });
    </script>
</body>
</html>
