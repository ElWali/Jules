<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RQpedia — Moroccan Archaeological Sites</title>
<meta name="description" content="Interactive map of Moroccan archaeological sites with search, autocomplete, and detailed information panel.">

<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
:root {
  --primary: #1e40af; --primary-dark: #1d4ed8;
  --surface: #ffffff; --background: #f8fafc;
  --on-surface: #1e293b; --on-background: #334155;
  --outline: #cbd5e1; --shadow: rgba(0,0,0,0.1); --shadow-strong: rgba(0,0,0,0.15);
  --error: #dc2626; --success: #166534; --success-bg: #dcfce7; --success-border: #a7f3d0;
  --divider: #e2e8f0; --hover-bg: #dbeafe; --focus-ring: #2563eb;
}

* { margin:0; padding:0; box-sizing:border-box; font-family:'Roboto', sans-serif; }
html, body { height:100%; display:flex; flex-direction:column; background:var(--background); color:var(--on-background); }
header { background: var(--surface); padding:16px 32px; display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:12px; box-shadow:0 2px 8px var(--shadow); position:sticky; top:0; z-index:1000; }
.logo a { font-size:1.75rem; font-weight:700; text-decoration:none; color:var(--on-surface); }
.nav-links { display:flex; gap:24px; flex-wrap:wrap; }
.nav-links a { color: var(--on-surface); text-decoration:none; font-weight:500; }
.header-actions { display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
.search-container { position:relative; max-width:320px; width:100%; }
input#search-input { width:100%; padding:12px 20px; border-radius:24px; border:1px solid transparent; font-size:1rem; background:white; box-shadow:0 2px 6px var(--shadow); outline:none; transition:0.2s; }
input#search-input:focus { box-shadow:0 4px 12px var(--shadow-strong); border-color: var(--primary-dark); outline:2px solid var(--focus-ring); outline-offset:2px; }
.loading-indicator { position:absolute; right:14px; top:50%; transform:translateY(-50%); display:none; font-size:14px; color:var(--on-background);}
input.loading + .loading-indicator { display:block; }
.autocomplete-results { position:absolute; top:100%; left:0; right:0; background:var(--surface); border-radius:12px; box-shadow:0 4px 12px var(--shadow-strong); border:1px solid var(--divider); margin-top:6px; max-height:240px; overflow-y:auto; display:none; z-index:2000; }
.suggestion { padding:12px 16px; cursor:pointer; transition:background 0.15s; }
.suggestion:hover, .suggestion.active { background:var(--hover-bg); }
.suggestion:active { background:var(--primary); color:white; }

/* Map */
#map-container { flex:1; min-height:300px; position:relative; }
#map { width:100%; height:100%; }

/* Info Panel */
.info-panel { background:var(--surface); max-height:50vh; display:flex; flex-direction:column; border-top:1px solid var(--divider); transition:all 0.3s; overflow:hidden; }
.info-panel-content { max-width:1200px; margin:0 auto; padding:16px; display:flex; flex-direction:column; flex:1; min-height:0; }
.location-info { display:none; flex-direction:column; flex:1; min-height:0; border-radius:16px; padding:20px; background:var(--surface); border:1px solid var(--divider); box-shadow:0 2px 6px var(--shadow),0 1px 2px var(--shadow); }
.location-info.show { display:flex; }
.info-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; flex-wrap:wrap; gap:8px; }
.info-title { font-size:1.25rem; font-weight:500; color:var(--on-surface); flex:1; min-width:0; }
.info-coords { font-family:'Roboto Mono'; font-size:0.8rem; background:var(--divider); padding:4px 8px; border-radius:6px; color:#475569; flex-shrink:0; white-space:nowrap; }
.info-text { font-size:0.95rem; color:var(--on-background); line-height:1.6; overflow-y:auto; padding-right:8px; flex:1; min-height:60px; margin-bottom:12px; }
.info-text p { margin:0 0 12px 0; }
.info-text p:last-child { margin-bottom:0; }
.action-buttons { display:flex; gap:12px; flex-wrap:wrap; }
.btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 16px; border-radius:24px; font-size:0.9rem; font-weight:500; border:1px solid var(--outline); background:var(--background); color:var(--on-background); cursor:pointer; transition:0.2s; min-height:40px; white-space:nowrap; }
.btn:hover { background:var(--hover-bg); box-shadow:0 1px 3px rgba(0,0,0,0.05); }
.btn.copied { background:var(--success-bg); color:var(--success); border-color:var(--success-border); }
.btn.copied::after { content:" ✓"; }
.status-divider { height:1px; background:var(--divider); margin:8px 0; }
.status-message { text-align:center; font-size:0.95rem; color:#64748b; padding:16px 0 12px; }
.spinner { animation:blink 1.4s infinite; font-size:14px; display:inline-block; }
@keyframes blink { 0%,100%{opacity:0.2}50%{opacity:1} }

footer { background:var(--surface); padding:24px 32px; border-top:1px solid var(--divider); text-align:center; font-size:0.9rem; color:#64748b; }
footer a { color:var(--primary); text-decoration:none; }

@media(max-width:768px){ header{flex-direction:column; align-items:flex-start; gap:8px} .nav-links{gap:12px;} .action-buttons{flex-direction:column;} .btn{width:100%; justify-content:center;} }
</style>
</head>
<body>
<header>
  <div class="logo"><a href="index.html">RQpedia</a></div>
  <nav class="nav-links">
    <a href="sites.html">Browse data</a>
    <a href="about.html">About</a>
    <a href="contribute.html">Contribute</a>
  </nav>
  <div class="header-actions">
    <div class="search-container">
      <input type="text" id="search-input" placeholder="Search any site..." autocomplete="off" />
      <div class="loading-indicator"><span class="spinner">●●●</span></div>
      <div class="autocomplete-results" id="autocomplete-results"></div>
    </div>
  </div>
</header>

<div id="map-container">
  <div id="map"></div>
</div>

<div class="info-panel">
  <div class="info-panel-content">
    <div class="location-info" id="info">
      <div class="info-header">
        <h2 class="info-title" id="info-title"></h2>
        <div class="info-coords" id="info-coords"></div>
      </div>
      <div class="info-text" id="info-text"></div>
      <div class="action-buttons">
        <button id="copy-coords-btn" class="btn"><i class="bi bi-clipboard"></i> Copy coordinates</button>
        <button id="share-view-btn" class="btn"><i class="bi bi-share"></i> Share view</button>
      </div>
    </div>
    <div class="status-divider"></div>
    <div class="status-message" id="status-message">Search for a Moroccan archaeological site</div>
  </div>
</div>

<footer>
  <p>This work is licensed under <a href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>.</p>
  <p><a href="https://github.com/xronos-ch/xronos.rails/">View source on GitHub</a></p>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let allPlaces = [];

async function loadData() {
  try {
    const res = await fetch('output.json');
    if (!res.ok) throw new Error('Failed to fetch JSON data');
    const data = await res.json();

    const uniqueSites = new Set();
    allPlaces = data.map(item => {
      const lat = parseFloat(item.lat), lon = parseFloat(item.lng);
      if (!item.site || isNaN(lat) || isNaN(lon)) return null;
      const key = item.site.toLowerCase();
      if (uniqueSites.has(key)) return null;
      uniqueSites.add(key);

      const fieldLabels = {
        d:'Sample ID', labnr:'Laboratory Number', bp:'Radiocarbon Age (BP)', std:'Uncertainty',
        'delta c13':'δ¹³C', 'feature type':'Feature Type', site:'Site Name', country:'Country',
        lat:'Latitude', lng:'Longitude', 'site type':'Site Type', periods:'Cultural Period(s)',
        'typochronological units':'Typochronological Unit(s)',
        'ecochronological units':'Ecochronological Unit(s)',
        reference:'Reference'
      };
      const skipFields = ['d','lat','lng'];

      const extractParts = [];
      for (const key in item) {
        if (!item.hasOwnProperty(key)) continue;
        let value = item[key];
        if (!value) continue;
        if (typeof value==='string' && (value.startsWith('[')||value.startsWith('{'))) {
          try { const parsed = JSON.parse(value); if(Array.isArray(parsed)){value=parsed.map(p=>Object.values(p)[0]||'').filter(v=>v).join(', ');} }catch(e){}
        }
        if(skipFields.includes(key)) continue;
        let displayValue = value;
        if(key==='country' && value==='MA') displayValue='Morocco';
        else if(key==='bp') displayValue=`${parseFloat(value).toFixed(1)} years BP`;
        else if(key==='std') displayValue=`±${parseFloat(value).toFixed(1)} years`;
        else if(key==='delta c13') displayValue=`${parseFloat(value).toFixed(1)} ‰`;
        const label = fieldLabels[key]||key.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
        extractParts.push(`<strong>${label}:</strong> ${displayValue}`);
      }
      return { display_name:item.site, lat, lon, extract:extractParts.join('<br>') };
    }).filter(Boolean);

    initializeApp();
  } catch(e) { console.error(e); showStatus('Error loading site data.',true); }
}

function initializeApp() {
  const map = L.map('map').setView([31.8,-6.0],6);
  const esriLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
    attribution:'&copy; <a href="https://www.esri.com">Esri</a>', maxZoom:19
  }).addTo(map);
  map.attributionControl.setPrefix('');

  const searchInput = document.getElementById('search-input');
  const autocompleteResults = document.getElementById('autocomplete-results');
  const statusMessageEl = document.getElementById('status-message');
  const locationInfoEl = document.getElementById('info');
  const infoTitleEl = document.getElementById('info-title');
  const infoTextEl = document.getElementById('info-text');
  const infoCoordsEl = document.getElementById('info-coords');
  const copyCoordsBtn = document.getElementById('copy-coords-btn');
  const shareViewBtn = document.getElementById('share-view-btn');

  let currentMarker=null, currentCoords=null;
  const searchResultLayer=L.layerGroup().addTo(map);

  function showStatus(msg,isError=false){ statusMessageEl.textContent=msg; statusMessageEl.style.color=isError?'#dc2626':'#64748b'; statusMessageEl.style.display='block'; locationInfoEl.classList.remove('show'); }

  function showPlaceInfo(place){
    const {display_name,lat,lon,extract}=place;
    currentCoords={lat,lon};
    infoCoordsEl.textContent=`${lat.toFixed(4)}, ${lon.toFixed(4)}`;
    infoTitleEl.textContent=display_name;
    infoTextEl.innerHTML=extract+`<br><p><a href="profile.html?id=${encodeURIComponent(display_name)}">Click for details</a></p>`;
    locationInfoEl.classList.add('show'); statusMessageEl.style.display='none';
  }

  function renderSuggestions(filtered){
    autocompleteResults.innerHTML=''; if(filtered.length===0){ autocompleteResults.style.display='none'; return; }
    filtered.forEach(place=>{ const div=document.createElement('div'); div.className='suggestion'; div.textContent=place.display_name;
      div.addEventListener('click',()=>selectPlace(place)); autocompleteResults.appendChild(div); });
    autocompleteResults.style.display='block';
  }

  function hideAutocomplete(){ autocompleteResults.style.display='none'; }

  function selectPlace(place){
    if(!place) return;
    searchInput.value=place.display_name; hideAutocomplete(); searchInput.blur();
    if(currentMarker) map.removeLayer(currentMarker);
    currentMarker=L.marker([place.lat,place.lon]).addTo(map); map.setView([place.lat,place.lon],10);
    showPlaceInfo(place);
  }

  function handleSearch(query){
    if(!query.trim()){ hideAutocomplete(); return; }
    const filtered=allPlaces.filter(p=>p.display_name.toLowerCase().includes(query.toLowerCase())).slice(0,5);
    renderSuggestions(filtered);
  }

  function handleManualSearch(){
    const query=searchInput.value.trim(); if(!query) return;
    const exact=allPlaces.find(p=>p.display_name.toLowerCase()===query.toLowerCase());
    if(exact) { selectPlace(exact); return; }
    const partial=allPlaces.find(p=>p.display_name.toLowerCase().includes(query.toLowerCase()));
    if(partial) { selectPlace(partial); return; }
    showStatus('No matching site found.',true); if(currentMarker){ map.removeLayer(currentMarker); currentMarker=null; } locationInfoEl.classList.remove('show');
  }

  searchInput.addEventListener('input',()=>handleSearch(searchInput.value));
  searchInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); hideAutocomplete(); handleManualSearch(); } });
  document.addEventListener('click',e=>{ if(!e.target.closest('.search-container')) hideAutocomplete(); });

  copyCoordsBtn.addEventListener('click',()=>{ if(currentCoords){ navigator.clipboard.writeText(`${currentCoords.lat.toFixed(4)},${currentCoords.lon.toFixed(4)}`).then(()=>{copyCoordsBtn.classList.add('copied'); setTimeout(()=>copyCoordsBtn.classList.remove('copied'),2000);}); } });
  shareViewBtn.addEventListener('click',()=>{ if(currentCoords){ const url=`${window.location.origin}${window.location.pathname}?lat=${currentCoords.lat}&lon=${currentCoords.lon}`; navigator.clipboard.writeText(url).then(()=>{ shareViewBtn.classList.add('copied'); setTimeout(()=>shareViewBtn.classList.remove('copied'),2000);}); } });

  showStatus('Enter a site name above to start searching.');
}

loadData();
</script>
</body>
</html>
