<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Profile</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        /* Minimal inline styles for Linked Data — keep main styles in style.css */
        .linked-data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.25rem;
            margin-top: 1rem;
        }
        .linked-source-card {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 1rem;
            background: #fafafa;
            font-size: 0.95rem;
        }
        .linked-source-card h4 {
            margin-top: 0;
            color: #2c3e50;
        }
        .linked-source-card img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin-top: 0.5rem;
        }
        .linked-source-card p {
            margin: 0.5rem 0;
            color: #555;
        }
        .linked-source-card a {
            color: #1a73e8;
            text-decoration: none;
        }
        .linked-source-card a:hover {
            text-decoration: underline;
        }
        @media (max-width: 600px) {
            .linked-data-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <a href="index.html">RQpedia</a>
        </div>
        <nav class="nav-links">
            <a href="sites.html">Browse data</a>
            <a href="about.html">About</a>
            <a href="contribute.html">Contribute</a>
        </nav>
        <div class="header-actions">
            <button class="search-button">Search</button>
            <button class="signin-button">Donate</button>
        </div>
    </header>

    <main class="container">
        <div class="site-header">
            <h1 id="site-name"></h1>
            <p class="site-type">Archaeological site in <span id="site-country-subheader"></span></p>
            <div class="site-meta">
                Record created in XRONOS on <span id="created-date"></span>. Last updated on <span id="updated-date"></span>.
                <a href="#changelog">See changelog for details.</a>
            </div>
        </div>

        <div class="info-card">
            <h2>Location</h2>
            <table>
                <tr>
                    <th>Coordinates (degrees)</th>
                    <td id="coords-deg"></td>
                </tr>
                <tr>
                    <th>Coordinates (DMS)</th>
                    <td id="coords-dms"></td>
                </tr>
                <tr>
                    <th>Country</th>
                    <td id="country"></td>
                </tr>
            </table>
        </div>

        <div id="map" style="height: 400px; margin-bottom: 20px;"></div>

        <!-- Updated Linked Data Section -->
        <div class="info-card" id="linked-data-section">
            <h2>Linked Open Data</h2>
            <div id="linked-data-content">
                <p>Loading linked open data from Wikidata, Wikimedia Commons, and DBpedia…</p>
            </div>
        </div>

        <div class="info-card">
            <h2>Radiocarbon Dates</h2>
            <table id="c14-table" class="table">
                <thead>
                    <tr>
                        <th>Lab ID</th>
                        <th>Context</th>
                        <th>Material</th>
                        <th>Taxon</th>
                        <th>Method</th>
                        <th>Uncalibrated age</th>
                        <th>Calibrated age</th>
                        <th>References</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div class="info-card">
            <h2>Typological Dates</h2>
            <table id="typo-table" class="table">
                <thead>
                    <tr>
                        <th>Classification</th>
                        <th>Estimated age</th>
                        <th>References</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div class="info-card">
            <h2>Bibliographic References</h2>
            <div id="references-container"></div>
        </div>

        <div class="info-card" id="changelog">
            <h2>Open data related to the archaeological site</h2>
            <p>Display open data related to the archaeological site fetched automatically from Wikimedia Commons, Wikidata and other open data sources (images, videos, ...)</p>
            <div id="changelog-container"></div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <p>This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</p>
            <p><a href="https://github.com/xronos-ch/xronos.rails/">View source on GitHub</a></p>
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="parser.js"></script>
    <script src="profile.js"></script>
    <script>
        // Utility: escape HTML
        const escapeHtml = (str) => str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));

        // Render a single card
        function createCard(source, title, description = '', imageUrl = '', url = '#') {
            const safeTitle = escapeHtml(title);
            const safeDesc = escapeHtml(description || '');
            return `
                <div class="linked-source-card">
                    <h4>${safeTitle} <small>(${source})</small></h4>
                    ${description ? `<p>${safeDesc}</p>` : ''}
                    ${imageUrl ? `<img src="${escapeHtml(imageUrl)}" alt="${safeTitle}" loading="lazy">` : ''}
                    <a href="${escapeHtml(url)}" target="_blank" rel="noopener">View on ${source}</a>
                </div>
            `;
        }

        // Fetch from Wikidata (by QID or name)
        async function fetchWikidata(siteName, wikidataId = null) {
            let entityId = wikidataId;
            if (!entityId || !entityId.startsWith('Q')) {
                // Search by name
                const searchUrl = `https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(siteName)}&language=en&limit=1&format=json&origin=*`;
                const res = await fetch(searchUrl);
                const data = await res.json();
                if (data.search && data.search.length > 0) {
                    entityId = data.search[0].id;
                } else {
                    return null;
                }
            }

            const url = `https://www.wikidata.org/wiki/Special:EntityData/${entityId}.json`;
            const res = await fetch(url);
            const data = await res.json();
            const entity = data.entities[entityId];
            if (!entity) return null;

            const label = entity.labels?.en?.value || siteName;
            const desc = entity.descriptions?.en?.value || '';
            const wdUrl = `https://www.wikidata.org/wiki/${entityId}`;

            let imageUrl = '';
            if (entity.claims?.P18) {
                const fileName = entity.claims.P18[0].mainsnak.datavalue.value;
                imageUrl = `https://commons.wikimedia.org/wiki/Special:FilePath/${encodeURIComponent(fileName)}?width=300`;
            }

            return { source: 'Wikidata', title: label, description: desc, imageUrl, url: wdUrl, entityId };
        }

        // Fetch additional media from Wikimedia Commons via SPARQL
        async function fetchCommonsMedia(entityId) {
            if (!entityId) return [];
            const query = `
                SELECT ?file ?fileUrl ?caption WHERE {
                  wd:${entityId} wdt:P18|wdt:P180 ?file .
                  BIND(CONCAT("https://commons.wikimedia.org/wiki/Special:FilePath/", 
                    REPLACE(STRAFTER(STR(?file), "Special:FilePath/"), " ", "_")) AS ?fileUrl)
                } LIMIT 3
            `;
            const encodedQuery = encodeURIComponent(query);
            const url = `https://query.wikidata.org/sparql?query=${encodedQuery}&format=json`;
            try {
                const res = await fetch(url, { headers: { 'Accept': 'application/sparql-results+json' } });
                const data = await res.json();
                return data.results.bindings.map(b => ({
                    source: 'Wikimedia Commons',
                    title: 'Media file',
                    imageUrl: b.fileUrl.value + '?width=300',
                    url: b.file.value
                }));
            } catch (e) {
                console.warn('SPARQL media fetch failed:', e);
                return [];
            }
        }

        // Fetch from DBpedia
        async function fetchDBpedia(siteName) {
            const cleanName = siteName.replace(/ /g, '_');
            const url = `https://dbpedia.org/data/${encodeURIComponent(cleanName)}.json`;
            try {
                const res = await fetch(url);
                if (!res.ok) return null;
                const data = await res.json();
                const resource = `http://dbpedia.org/resource/${cleanName}`;
                const graph = data[resource];
                if (!graph) return null;

                const abstract = graph['http://dbpedia.org/ontology/abstract']?.find(a => a.lang === 'en')?.value;
                const thumbnail = graph['http://dbpedia.org/ontology/thumbnail']?.[0]?.value;
                const dbUrl = `https://dbpedia.org/page/${cleanName}`;

                if (abstract || thumbnail) {
                    return { source: 'DBpedia', title: siteName, description: abstract, imageUrl: thumbnail, url: dbUrl };
                }
            } catch (e) {
                console.warn('DBpedia fetch failed:', e);
            }
            return null;
        }

        // Main function to fetch and render all linked data
        async function fetchAndRenderLinkedData(siteName, wikidataId = null) {
            const container = document.getElementById('linked-data-content');
            container.innerHTML = '<p>Loading linked open data from Wikidata, Wikimedia Commons, and DBpedia…</p>';

            try {
                const [wdData, dbData] = await Promise.all([
                    fetchWikidata(siteName, wikidataId),
                    fetchDBpedia(siteName)
                ]);

                let cards = [];

                if (wdData) {
                    cards.push(createCard(wdData.source, wdData.title, wdData.description, wdData.imageUrl, wdData.url));
                    // Fetch extra media if QID available
                    if (wdData.entityId) {
                        const media = await fetchCommonsMedia(wdData.entityId);
                        cards = cards.concat(media.map(m => createCard(m.source, m.title, '', m.imageUrl, m.url)));
                    }
                }

                if (dbData) {
                    // Avoid duplicate if DBpedia and Wikidata refer to same thing
                    const exists = cards.some(c => c.includes(dbData.url));
                    if (!exists) {
                        cards.push(createCard(dbData.source, dbData.title, dbData.description, dbData.imageUrl, dbData.url));
                    }
                }

                if (cards.length > 0) {
                    container.innerHTML = `<div class="linked-data-grid">${cards.join('')}</div>`;
                } else {
                    container.innerHTML = '<p>No linked open data found for this site.</p>';
                }
            } catch (error) {
                console.error('Error fetching linked data:', error);
                container.innerHTML = '<p>Failed to load linked open data. Please try again later.</p>';
            }
        }

        // Main DOM load handler
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const siteName = decodeURIComponent(urlParams.get('id') || '').trim();
            if (!siteName) {
                document.getElementById('site-name').textContent = "Site not specified";
                document.getElementById('linked-data-content').innerHTML = '<p>No site ID provided.</p>';
                return;
            }

            fetch('output.json')
                .then(response => {
                    if (!response.ok) throw new Error('output.json not found');
                    return response.json();
                })
                .then(data => {
                    renderProfilePage(siteName, data);

                    const siteData = data[siteName] || {};
                    const wikidataId = siteData.wikidata_id || null;

                    fetchAndRenderLinkedData(siteName, wikidataId);
                })
                .catch(error => {
                    console.error("Failed to load site data:", error);
                    document.getElementById('site-name').textContent = "Error loading site data";
                    document.getElementById('linked-data-content').innerHTML = '<p>Could not load linked data.</p>';
                });
        });
    </script>
</body>
</html>

