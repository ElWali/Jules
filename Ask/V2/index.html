<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RQpedia — Moroccan Archaeological Sites</title>
<meta name="description" content="Browse Moroccan archaeological sites, view locations, radiocarbon dates, and references.">

<!-- Fonts & icons -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
    --bg:#0f1724;
    --surface:#0b1220;
    --muted:#94a3b8;
    --text:#e6eef8;
    --accent:#06b6d4;
    --outline: rgba(255,255,255,0.06);
    --shadow: rgba(2,6,23,0.6);
    --hover-bg: rgba(6,182,212,0.1);
    font-family: 'Roboto', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#071024,#071a2b);color:var(--text);}
header{display:flex;align-items:center;gap:16px;padding:14px 20px;border-bottom:1px solid var(--outline);background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent);}
.logo a{font-weight:700;color:var(--text);text-decoration:none;font-size:1.05rem;}
nav.nav-links{display:flex;gap:12px;margin-left:8px;}
nav.nav-links a{color:var(--muted);text-decoration:none;font-size:0.95rem;}
.header-actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap;}
.header-actions button{background:transparent;border:1px solid var(--outline);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer;}
main.container{max-width:1100px;margin:20px auto;padding:18px;display:grid;grid-template-columns:320px 1fr;gap:18px;}
aside .panel{background:linear-gradient(180deg,#061028,#071a2b);border:1px solid var(--outline);border-radius:10px;padding:14px;box-shadow:0 6px 20px var(--shadow);}
aside .panel h3{margin:0 0 8px 0;font-size:1rem;}
#site-selector,#search-filter{width:100%;padding:8px;border-radius:8px;border:1px solid var(--outline);background:transparent;color:var(--text);margin-top:4px;}
.meta-small{font-size:0.85rem;color:var(--muted);margin-top:8px;}
.site-header{grid-column:2;display:flex;flex-direction:column;gap:6px;}
h1#site-name{margin:0;font-size:1.6rem;}
.site-type{color:var(--muted);margin:0;}
.info-card{background:linear-gradient(180deg,#07132a,#071228);border:1px solid var(--outline);border-radius:10px;padding:14px;margin-bottom:12px;}
table{width:100%;border-collapse:collapse;color:var(--text);}
table th{text-align:left;font-weight:600;padding:8px 6px;color:var(--muted);font-size:0.85rem;}
table td{padding:8px 6px;border-top:1px dashed rgba(255,255,255,0.02);font-size:0.95rem;}
#map{height:320px;border-radius:8px;border:1px solid var(--outline);overflow:hidden;margin-top:8px;}
button.small-btn{padding:6px 10px;border-radius:8px;border:1px solid var(--outline);background:transparent;color:var(--text);cursor:pointer;}
.suggestion-list{position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1px solid var(--outline);border-radius:8px;max-height:200px;overflow-y:auto;z-index:100;}
.suggestion-list div{padding:6px 12px;cursor:pointer;}
.suggestion-list div:hover{background:var(--hover-bg);}
@media (max-width:980px){main.container{grid-template-columns:1fr;padding:12px;} .site-header{grid-column:1;}}
</style>
</head>
<body>

<header>
    <div class="logo"><a href="index.html">RQpedia</a></div>
    <nav class="nav-links" aria-label="Main navigation">
        <a href="sites.html">Browse data</a>
        <a href="about.html">About</a>
        <a href="contribute.html">Contribute</a>
    </nav>
    <div class="header-actions" role="toolbar" aria-label="Top actions">
        <input id="search-filter" placeholder="Search sites..." aria-label="Search sites">
        <button id="download-all" class="small-btn">Download all JSON</button>
    </div>
</header>

<main class="container">

<!-- LEFT PANEL -->
<aside>
    <div class="panel">
        <h3>Site Selector</h3>
        <select id="site-selector" aria-label="Site selector"></select>
        <div class="meta-small" id="selected-count"></div>
        <div style="margin-top:8px;">
            <button id="prev-site" class="small-btn"><i class="bi bi-skip-start"></i> Prev</button>
            <button id="next-site" class="small-btn">Next <i class="bi bi-skip-end"></i></button>
        </div>
    </div>

    <div class="panel" style="margin-top:12px;">
        <h3>Linked Data (cached)</h3>
        <div id="linked-data-content" style="min-height:80px;color:var(--muted)">No site selected.</div>
        <button id="clear-linked-cache" class="small-btn" style="margin-top:8px;">Clear linked-data cache</button>
    </div>

    <div class="panel" style="margin-top:12px;">
        <h3>Media</h3>
        <div id="media-content" style="min-height:80px;color:var(--muted)">No site selected.</div>
    </div>
</aside>

<!-- RIGHT PANEL -->
<section>
    <div class="site-header">
        <h1 id="site-name">Select a site</h1>
        <p class="site-type">Archaeological site in <span id="site-country-subheader">—</span></p>
        <div class="meta-small site-meta" id="site-meta">Records loaded: <span id="loaded-count">0</span></div>
    </div>

    <div class="info-card">
        <h2>Location & Map</h2>
        <table>
            <tr><th>Coordinates (deg)</th><td id="coords-deg">—</td></tr>
            <tr><th>Coordinates (DMS)</th><td id="coords-dms">—</td></tr>
            <tr><th>Country</th><td id="country">—</td></tr>
            <tr><th>Site type</th><td id="site-type">—</td></tr>
        </table>
        <div id="map" aria-label="Site map"></div>
        <div style="margin-top:8px;">
            <button id="copy-coords-btn" class="small-btn">Copy coordinates</button>
            <button id="share-view-btn" class="small-btn">Share view</button>
        </div>
    </div>

    <div class="info-card">
        <h2>Site Information</h2>
        <div id="site-info" style="min-height:80px;color:var(--muted)">Select a site to view details.</div>
    </div>
</section>
</main>

<footer>
    <p>This work is licensed under <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank" style="color:var(--accent)">CC BY 4.0</a>.</p>
    <p><a href="https://github.com/ElWali/Jules" target="_blank" style="color:var(--muted)">Project repo</a></p>
</footer>

<script>
let allPlaces = [];
let currentIndex = 0;
let map, currentMarker=null;

async function loadData(){
    try{
        const res = await fetch('output.json');
        if(!res.ok) throw new Error('Failed to load JSON');
        const data = await res.json();
        allPlaces = data.filter(item=>item.site && !isNaN(parseFloat(item.lat)) && !isNaN(parseFloat(item.lng)))
                        .map(item=>({
                            ...item,
                            lat: parseFloat(item.lat),
                            lon: parseFloat(item.lng),
                            display_name:item.site
                        }));
        document.getElementById('loaded-count').textContent = allPlaces.length;
        populateSelector();
        initializeMap();
    }catch(e){console.error(e);}
}

function populateSelector(){
    const sel = document.getElementById('site-selector');
    sel.innerHTML = '';
    allPlaces.forEach((p,i)=>{ 
        const opt = document.createElement('option'); opt.value=i; opt.textContent=p.display_name; sel.appendChild(opt);
    });
}

function initializeMap(){
    map = L.map('map').setView([31.8,-6],6);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
        attribution:'&copy; Esri',
        maxZoom:19
    }).addTo(map);
}

function showSite(index){
    if(index<0 || index>=allPlaces.length) return;
    currentIndex=index;
    const p=allPlaces[index];
    document.getElementById('site-name').textContent=p.display_name;
    document.getElementById('site-country-subheader').textContent=p.country || 'Morocco';
    document.getElementById('coords-deg').textContent=`${p.lat.toFixed(4)}, ${p.lon.toFixed(4)}`;
    document.getElementById('coords-dms').textContent = degToDMS(p.lat,p.lon);
    document.getElementById('country').textContent=p.country || 'Morocco';
    document.getElementById('site-type').textContent=p['site type']||'—';
    document.getElementById('site-info').textContent = p.description || 'No additional info available.';
    document.getElementById('site-selector').value=index;

    if(currentMarker) map.removeLayer(currentMarker);
    currentMarker = L.marker([p.lat,p.lon]).addTo(map).bindPopup(p.display_name).openPopup();
    map.setView([p.lat,p.lon],13);
}

function degToDMS(lat,lon){
    function toDMS(deg){const d=Math.floor(Math.abs(deg)); const m=Math.floor((Math.abs(deg)-d)*60); const s=((Math.abs(deg)-d-m/60)*3600).toFixed(2); return `${d}°${m}'${s}"`; }
    return `${toDMS(lat)} N, ${toDMS(lon)} E`;
}

document.getElementById('site-selector').addEventListener('change',e=>showSite(parseInt(e.target.value)));
document.getElementById('prev-site').addEventListener('click',()=>showSite(currentIndex-1));
document.getElementById('next-site').addEventListener('click',()=>showSite(currentIndex+1));

document.getElementById('search-filter').addEventListener('input',e=>{
    const query=e.target.value.toLowerCase();
    const sel = document.getElementById('site-selector');
    sel.innerHTML='';
    allPlaces.forEach((p,i)=>{ if(p.display_name.toLowerCase().includes(query)) { const opt=document.createElement('option'); opt.value=i; opt.textContent=p.display_name; sel.appendChild(opt);}});
    if(sel.options.length>0) showSite(parseInt(sel.options[0].value));
});

document.getElementById('copy-coords-btn').addEventListener('click',()=>{
    const txt = document.getElementById('coords-deg').textContent;
    navigator.clipboard.writeText(txt).then(()=>alert('Coordinates copied!'));
});

document.getElementById('share-view-btn').addEventListener('click',()=>{
    const p=allPlaces[currentIndex];
    if(!p) return;
    const url = `${location.origin}${location.pathname}?lat=${p.lat}&lon=${p.lon}&site=${encodeURIComponent(p.display_name)}`;
    prompt('Share this URL:', url);
});

document.getElementById('download-all').addEventListener('click',()=>{
    const blob = new Blob([JSON.stringify(allPlaces,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='all-sites.json'; a.click(); URL.revokeObjectURL(url);
});

loadData();
</script>

</body>
</html>
