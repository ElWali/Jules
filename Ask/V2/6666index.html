<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>RQpedia — Moroccan Archaeological Sites</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root{
    --bg:#0f1724; --surface:#0b1220; --muted:#94a3b8; --text:#e6eef8;
    --accent:#06b6d4; --outline:rgba(255,255,255,0.06); --shadow:rgba(2,6,23,0.6);
    font-family: "Roboto", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
html,body{margin:0;padding:0;height:100%;background:linear-gradient(180deg,#071024,#071a2b);color:var(--text);display:flex;flex-direction:column;}
header{display:flex;align-items:center;gap:16px;padding:14px 20px;border-bottom:1px solid var(--outline);background:linear-gradient(90deg, rgba(255,255,255,0.01), transparent);}
.logo a{font-weight:700;color:var(--text);text-decoration:none;font-size:1.2rem}
nav.nav-links{display:flex;gap:12px;margin-left:8px}
nav.nav-links a{color:var(--muted);text-decoration:none;font-size:0.95rem}
.header-actions{margin-left:auto;display:flex;gap:8px;align-items:center;position:relative;width:100%;max-width:400px;}
#search-input{width:100%;padding:8px 12px;border-radius:8px;border:1px solid var(--outline);background:transparent;color:var(--text);}
.autocomplete-results{position:absolute;top:100%;left:0;right:0;background:var(--surface);border:1px solid var(--outline);border-radius:8px;max-height:220px;overflow-y:auto;z-index:2000;display:none;}
.autocomplete-results .suggestion{padding:8px 12px;cursor:pointer;transition:background 0.15s;}
.autocomplete-results .suggestion:hover,.autocomplete-results .suggestion.active{background:rgba(6,182,212,0.1);}
.autocomplete-results .suggestion:active{background:var(--accent);color:#fff;}
main.container{display:grid;grid-template-columns:300px 1fr;flex:1;overflow:hidden;margin-top:8px}
aside.panel{background:linear-gradient(180deg,#061028,#071a2b);border:1px solid var(--outline);border-radius:10px;padding:14px;box-shadow:0 6px 20px rgba(2,6,23,0.6);display:flex;flex-direction:column}
aside.panel h3{margin:0 0 8px 0;font-size:1rem}
#site-selector{width:100%;padding:8px;border-radius:8px;border:1px solid var(--outline);background:transparent;color:var(--text);margin-bottom:12px}
.small-btn{padding:6px 10px;border-radius:8px;border:1px solid var(--outline);background:transparent;color:var(--text);cursor:pointer;margin-top:4px}
.meta-small{font-size:0.85rem;color:var(--muted);margin-top:8px}
#map-container{position:relative;flex:1;overflow:hidden}
#map{width:100%;height:100%}
.info-panel{background-color:var(--surface);padding:0;max-height:45vh;display:flex;flex-direction:column;transition:all 0.3s ease;border-top:1px solid var(--outline)}
.info-panel-content{max-width:1200px;margin:0 auto;display:flex;flex-direction:column;flex:1;padding:0 16px}
.location-info{display:none;flex-direction:column;flex:1;min-height:0;background:var(--surface);border-radius:16px;box-shadow:0 2px 6px var(--shadow),0 1px 2px var(--shadow);padding:20px;margin-top:12px;border:1px solid var(--outline)}
.location-info.show{display:flex}
.info-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;flex-wrap:wrap;gap:8px}
.info-title{font-size:1.25rem;font-weight:500;color:var(--text);margin:0;line-height:1.3;flex:1;min-width:0}
.info-coords{font-family:'Roboto Mono', monospace;font-size:0.8rem;background-color:var(--outline);padding:4px 8px;border-radius:6px;color:#475569;white-space:nowrap;flex-shrink:0}
.info-text{color:var(--text);font-size:0.95rem;line-height:1.6;overflow-y:auto;padding-right:8px;flex:1;margin-bottom:16px;min-height:60px}
.action-buttons{display:flex;flex-wrap:wrap;gap:12px;margin-top:auto}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:24px;font-size:0.9rem;font-weight:500;cursor:pointer;border:1px solid var(--outline);background:var(--bg);color:var(--text);white-space:nowrap;transition:background-color 0.2s, box-shadow 0.2s;min-height:40px}
.btn:hover{background-color:rgba(6,182,212,0.08);box-shadow:0 1px 3px rgba(0,0,0,0.05)}
.btn.copied{background-color:#dcfce7;color:#166534;border-color:#a7f3d0}
.btn.copied::after{content:" ✓"}
.status-message{text-align:center;color:var(--muted);font-size:0.95rem;line-height:1.5;padding:16px 0 12px;font-style:normal}
.spinner{animation:blink 1.4s infinite;display:inline-block;font-size:14px}
@keyframes blink{0%,100%{opacity:0.2}50%{opacity:1}}
footer{background:var(--surface);padding:24px 32px;border-top:1px solid var(--outline);text-align:center;font-size:0.9rem;color:var(--muted)}
footer a{color:var(--accent);text-decoration:none}
@media (max-width:980px){main.container{grid-template-columns:1fr;padding:12px}}
</style>
</head>
<body>

<header>
<div class="logo"><a href="index.html">RQpedia</a></div>
<nav class="nav-links"><a href="sites.html">Browse data</a><a href="about.html">About</a><a href="contribute.html">Contribute</a></nav>
<div class="header-actions">
<input id="search-input" placeholder="Search any site..." autocomplete="off">
<div class="autocomplete-results" id="autocomplete-results"></div>
</div>
</header>

<main class="container">
<aside class="panel">
<h3>Sites</h3>
<input id="site-selector" placeholder="Select a site..." />
<div class="meta-small" id="selected-count">Total sites: 0</div>
</aside>
<div id="map-container"><div id="map"></div></div>
</main>

<div class="info-panel">
<div class="info-panel-content">
<div class="location-info" id="info">
<div class="info-header">
<h2 class="info-title" id="info-title"></h2>
<div class="info-coords" id="info-coords"></div>
</div>
<div class="info-text" id="info-text"></div>
<div class="action-buttons">
<button id="copy-coords-btn" class="btn">Copy coordinates</button>
<button id="share-view-btn" class="btn">Share view</button>
</div>
</div>
<div class="status-message" id="status-message">Search for a Moroccan archaeological site</div>
</div>
</div>

<footer>
<div class="footer-content">
<p>This work is licensed under <a href="http://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>.</p>
<p><a href="https://github.com/xronos-ch/xronos.rails/">View source on GitHub</a></p>
</div>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let allPlaces=[],currentMarker=null,currentCoords=null,map,searchResultLayer,currentIndex=0;
const searchInput=document.getElementById('search-input');
const autocompleteResults=document.getElementById('autocomplete-results');

async function loadData(){
    try{
        const resp=await fetch('output.json'); const data=await resp.json();
        const unique=new Set();
        allPlaces=data.map(item=>{
            const lat=parseFloat(item.lat),lon=parseFloat(item.lng);
            if(!item.site||isNaN(lat)||isNaN(lon))return null;
            if(unique.has(item.site.toLowerCase()))return null;unique.add(item.site.toLowerCase());
            return {display_name:item.site,lat,lon,extract:''};
        }).filter(Boolean);
        populateSelector();
        initMap();
    }catch(e){console.error(e);}
}

function populateSelector(){
    const sel=document.getElementById('site-selector');
    sel.value='';
    document.getElementById('selected-count').textContent=`Total sites: ${allPlaces.length}`;
}

function initMap(){
    map=L.map('map',{zoomControl:true}).setView([31.8,-6],6);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'&copy; Esri',maxZoom:19}).addTo(map);
    map.attributionControl.setPrefix('');
    searchResultLayer=L.layerGroup().addTo(map);
    allPlaces.forEach(p=>{const m=L.marker([p.lat,p.lon]).addTo(searchResultLayer);m.on('click',()=>showPlaceInfo(p));});
}

function showPlaceInfo(place){
    currentCoords={lat:place.lat,lon:place.lon};
    document.getElementById('info-title').textContent=place.display_name;
    document.getElementById('info-coords').textContent=`${place.lat.toFixed(4)}, ${place.lon.toFixed(4)}`;
    document.getElementById('info-text').innerHTML=`<p><a href="profile.html?id=${encodeURIComponent(place.display_name)}">Click for details</a></p>`;
    document.getElementById('info').classList.add('show');
    map.setView([place.lat,place.lon],10);
}

function filterSuggestions(val){
    const filtered=allPlaces.filter(p=>p.display_name.toLowerCase().includes(val.toLowerCase())).slice(0,5);
    renderSuggestions(filtered);
}

function renderSuggestions(list){
    autocompleteResults.innerHTML=''; if(list.length===0){autocompleteResults.style.display='none';return;}
    list.forEach(p=>{const div=document.createElement('div');div.className='suggestion';div.textContent=p.display_name;
    div.addEventListener('click',()=>{selectPlace(p);}); autocompleteResults.appendChild(div);});
    autocompleteResults.style.display='block'; currentIndex=-1;
}

function selectPlace(p){
    searchInput.value=p.display_name;
    autocompleteResults.style.display='none';
    showPlaceInfo(p);
}

searchInput.addEventListener('input',()=>filterSuggestions(searchInput.value));
searchInput.addEventListener('keydown',e=>{
    const items=autocompleteResults.querySelectorAll('.suggestion');
    if(e.key==='ArrowDown'){currentIndex=(currentIndex+1)%items.length;items.forEach((el,i)=>el.classList.toggle('active',i===currentIndex));}
    else if(e.key==='ArrowUp'){currentIndex=(currentIndex-1+items.length)%items.length;items.forEach((el,i)=>el.classList.toggle('active',i===currentIndex));}
    else if(e.key==='Enter'){e.preventDefault();if(currentIndex>=0)selectPlace(allPlaces.find(p=>p.display_name===items[currentIndex].textContent));}
    else if(e.key==='Escape'){autocompleteResults.style.display='none';}
});
document.addEventListener('click',e=>{if(!searchInput.contains(e.target)&&!autocompleteResults.contains(e.target)){autocompleteResults.style.display='none';}});
document.getElementById('copy-coords-btn').addEventListener('click',async()=>{if(!currentCoords)return;try{await navigator.clipboard.writeText(`${currentCoords.lat.toFixed(6)}, ${currentCoords.lon.toFixed(6)}`);const btn=document.getElementById('copy-coords-btn');btn.classList.add('copied');setTimeout(()=>btn.classList.remove('copied'),2000);}catch(e){console.error(e);}});
document.getElementById('share-view-btn').addEventListener('click',async()=>{const center=map.getCenter();const zoom=map.getZoom();const link=`${window.location.origin+window.location.pathname}#lat=${center.lat.toFixed(6)}&lng=${center.lng.toFixed(6)}&z=${zoom}`;try{if(navigator.share){await navigator.share({title:'Moroccan Archaeological Site',url:link});}else{await navigator.clipboard.writeText(link);}const btn=document.getElementById('share-view-btn');btn.classList.add('copied');setTimeout(()=>btn.classList.remove('copied'),2000);}catch(e){alert('Failed to share link');}});
window.addEventListener('load',loadData);
</script>

</body>
</html>
